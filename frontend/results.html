<!DOCTYPE html>
<html>

<head>
    <title>GP - Results</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav><a href="index.html">Home</a><a href="grids.html">Grids</a><a href="restrictions.html">Restrictions</a><a
            href="results.html">Results</a></nav>
    <div class="dashboard">
        <h3>Analysis Results</h3>
        <div class="control-group">
            <label>Grid</label>
            <select id="grid-select">
                <option value="delft_municipality">Municipality</option>
                <option value="delft_districts" selected>Districts</option>
                <option value="delft_neighborhoods">Neighborhoods</option>
                <option value="res_8">Res 8</option>
                <option value="res_9">Res 9</option>
                <option value="res_10">Res 10</option>
            </select>
        </div>
        <div class="control-group">
            <label>Scenario</label>
            <select id="scenario-select">
                <option value="s1">S1: Baseline</option>
                <option value="s2">S2: Constraints</option>
                <option value="s3" selected>S3: Trees & Constraints</option>
            </select>
        </div>
        <div class="stats-box">
            <div class="stat-item"><span>TEI Index:</span><span id="tei-val" class="stat-value">-</span></div>
            <div class="stat-item"><span>Mean Green Score:</span><span id="mean-val" class="stat-value">-</span></div>
            <div class="legend-bar"></div>
        </div>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/config.js"></script>
    <script src="js/layerManager.js"></script>
    <script>
        const map = L.map('map').setView(MAP_SETTINGS.center, MAP_SETTINGS.zoom);
        L.tileLayer(MAP_SETTINGS.tiles).addTo(map);
        let layer;
        async function update() {
            if (layer) map.removeLayer(layer);
            const grid = document.getElementById('grid-select').value;
            const scenario = document.getElementById('scenario-select').value;
            const data = await fetchGeoJSON(DATA_PATHS.results(grid, scenario));
            if (!data) return;

            document.getElementById('tei-val').innerText = data.tei_score.toFixed(4);
            document.getElementById('mean-val').innerText = data.mean_green_score.toFixed(5);

            const stats = { low: data.stats?.low_bound || 0, high: data.stats?.high_bound || 0.01 };
            layer = L.geoJson(data, {
                style: (f) => ({ fillColor: getScoreColor(f.properties.green_score, stats.low, stats.high), weight: 0.5, color: 'white', fillOpacity: 0.7 }),
                onEachFeature: (f, l) => l.bindPopup(`Score: ${f.properties.green_score.toFixed(5)}`)
            }).addTo(map);
        }
        document.querySelectorAll('select').forEach(s => s.onchange = update);
        update();
    </script>
</body>

</html>
